# TIL - 2025.08.14 - JPA ë‹¤ëŒ€ë‹¤ ê´€ê³„ ë§¤í•‘ê³¼ íŒŒì¼ ì—…ë¡œë“œ êµ¬í˜„ ê°œë… ì´í•´

## ì¹´í…Œê³ ë¦¬ ğŸ·ï¸

#TIL #Spring #JPA #ManyToMany #FileUpload #Multipart #JavaScript

---

## ì˜¤ëŠ˜ ë°°ìš´ ë‚´ìš© ğŸ”

* JPAì—ì„œ ë‹¤ëŒ€ë‹¤(M\:N) ê´€ê³„ë¥¼ ì—°ê²° ì—”í‹°í‹°(`TravelLogTag`)ë¥¼ í†µí•´ êµ¬í˜„í•˜ëŠ” ë°©ë²•
* Spring Bootì—ì„œì˜ íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ íë¦„ (ë¡œì»¬ ì €ì¥ ë° ë©”íƒ€ë°ì´í„° DB ê´€ë¦¬)
* `multipart/form-data` ìš”ì²­ì„ `@RequestPart` ì• ë…¸í…Œì´ì…˜ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ë°©ë²•
* ì™¸ë¶€ ê²½ë¡œì˜ ì •ì  ë¦¬ì†ŒìŠ¤(ì—…ë¡œë“œëœ íŒŒì¼)ë¥¼ ì›¹ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ ì„¤ì • (`WebMvcConfigurer`)
* JavaScriptë¥¼ ì´ìš©í•œ ë³µì¡í•œ í¼ UI ì²˜ë¦¬ (ì´ë¯¸ì§€ ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°, íƒœê·¸ ì‹œìŠ¤í…œ, ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì •ë ¬)
* JPA ì—”í‹°í‹° ë‚´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§(í¸ì˜ ë©”ì„œë“œ)ì˜ ì—­í• ê³¼ ì¤‘ìš”ì„±

---

## ì–´ë ¤ì› ë˜ ì  ğŸ’£

* ë‹¤ëŒ€ë‹¤ ê´€ê³„ë¥¼ ìœ„í•œ ì—°ê²° ì—”í‹°í‹°ì˜ PKë¥¼ ë³µí•© í‚¤ë¡œ í• ì§€, ë…ë¦½ì ì¸ ëŒ€ë¦¬ í‚¤ë¡œ í• ì§€ í˜¼ë€ìŠ¤ëŸ¬ì› ë‹¤. ì‹¤ë¬´ì—ì„œëŠ” ê´€ë¦¬ ìš©ì´ì„± ë•Œë¬¸ì— ë¹„ì‹ë³„ ê´€ê³„ ë°©ì‹ì´ ë” ë§ì´ ì“°ì¸ë‹¤ëŠ” ì ì„ ì•Œê²Œ ë˜ì—ˆë‹¤.

* JSONê³¼ íŒŒì¼ì„ ë™ì‹œì— ì²˜ë¦¬í•˜ëŠ” ë°©ë²•ì´ ë‚¯ì„¤ì—ˆë‹¤. `@RequestBody`ê°€ ì•„ë‹Œ `@RequestPart`ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤ëŠ” ì ì„ í•™ìŠµí–ˆë‹¤.

* ë¡œì»¬ ê²½ë¡œì™€ ì›¹ ì ‘ê·¼ ê²½ë¡œê°€ ë‹¤ë¥´ë‹¤ëŠ” ì ì„ ëª…í™•íˆ ì´í•´í•˜ëŠ” ë° ì‹œê°„ì´ ê±¸ë ¸ë‹¤. `WebMvcConfigurer`ì—ì„œ ë§¤í•‘ ì„¤ì •ì„ ë°˜ë“œì‹œ í•´ì•¼ ì›¹ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í–ˆë‹¤.

* í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì—¬ëŸ¬ íŒŒì¼ ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°ì™€ ìˆœì„œ ë³€ê²½ UIë¥¼ êµ¬í˜„í•˜ëŠ” ê³¼ì •ì´ ê¹Œë‹¤ë¡œì› ë‹¤. `File` ê°ì²´ì™€ ì´ë²¤íŠ¸ íë¦„ì— ëŒ€í•œ ê¹Šì€ ì´í•´ê°€ í•„ìš”í–ˆë‹¤.

---

## ì •ë¦¬ ğŸ–‡ï¸

### 1. ì—°ê²° ì—”í‹°í‹°ë¥¼ í†µí•œ ë‹¤ëŒ€ë‹¤(M\:N) ê´€ê³„ ë§¤í•‘

* **í•™ìŠµ ëª©í‘œ (Why?)**
  `@ManyToMany`ì˜ í•œê³„ë¥¼ ê·¹ë³µí•˜ê³  ìœ ì—°í•œ ê´€ê³„ë¥¼ ì„¤ê³„í•˜ê¸° ìœ„í•¨ì´ë‹¤.

* **í•µì‹¬ ì›ë¦¬ (What?)**

  * ì—°ê²° ì—”í‹°í‹°(`TravelLogTag`)ë¥¼ ë‘¬ì„œ ë‹¤ëŒ€ë‹¤ë¥¼ 1\:N-N:1 ê´€ê³„ë¡œ í’€ì–´ë‚¸ë‹¤.
  * ë¹„ì‹ë³„ ê´€ê³„ ë°©ì‹ì„ ì‚¬ìš©í•˜ë©´ ê´€ë¦¬ê°€ ìœ ì—°í•˜ê³  ì‹¤ë¬´ì—ì„œ ì„ í˜¸ëœë‹¤.

* **ë¬¸ë²• ë° ì‚¬ìš©ë²• (How?)**

  ```java
  @Entity
  public class TravelLogTag {
      @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
      private Long id;

      @ManyToOne(fetch = FetchType.LAZY)
      @JoinColumn(name = "travel_log_id")
      private TravelLog travelLog;

      @ManyToOne(fetch = FetchType.LAZY)
      @JoinColumn(name = "tag_id")
      private Tag tag;
  }
  ```

* **ì£¼ì˜ì‚¬í•­ ë° ì‹¤ë¬´ íŒ (Watch out for)**
  `addTag(Tag tag)` ê°™ì€ í¸ì˜ ë©”ì„œë“œë¥¼ ë‘ë©´ ì„œë¹„ìŠ¤ ë¡œì§ì´ ë‹¨ìˆœí•´ì§€ê³  ì‘ì§‘ë„ê°€ ë†’ì•„ì§„ë‹¤.

---

### 2. Spring Boot íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬

* **í•™ìŠµ ëª©í‘œ (Why?)**
  íŒŒì¼ ì‹œìŠ¤í…œê³¼ DBì˜ ì±…ì„ì„ ë¶„ë¦¬í•˜ì—¬ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê¸° ìœ„í•¨ì´ë‹¤.

* **í•µì‹¬ ì›ë¦¬ (What?)**

  * ì‹¤ì œ íŒŒì¼ì€ ë¡œì»¬ ê²½ë¡œë‚˜ í´ë¼ìš°ë“œ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•œë‹¤.
  * DBì—ëŠ” íŒŒì¼ ê²½ë¡œì™€ ë©”íƒ€ë°ì´í„°ë§Œ ì €ì¥í•œë‹¤.

* **ë¬¸ë²• ë° ì‚¬ìš©ë²• (How?)**

  ```java
  String storedFileName = UUID.randomUUID() + ".jpg";
  Path target = userBasePath.resolve(storedFileName);
  Files.copy(file.getInputStream(), target);

  TravelPhoto photo = TravelPhoto.builder()
      .filePath("/uploads/" + username + "/" + storedFileName)
      .build();
  travelPhotoRepository.save(photo);
  ```

* **ì£¼ì˜ì‚¬í•­ ë° ì‹¤ë¬´ íŒ (Watch out for)**
  ìš´ì˜ í™˜ê²½ì—ì„œëŠ” AWS S3 ê°™ì€ í´ë¼ìš°ë“œ ìŠ¤í† ë¦¬ì§€ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë°”ëŒì§í•˜ë‹¤.

---

### 3. @RequestPartë¥¼ ì´ìš©í•œ Multipart ìš”ì²­ ì²˜ë¦¬

* **í•™ìŠµ ëª©í‘œ (Why?)**
  JSONê³¼ íŒŒì¼ì„ í•˜ë‚˜ì˜ ìš”ì²­ìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬ íš¨ìœ¨ì„±ì„ ë†’ì´ê¸° ìœ„í•¨ì´ë‹¤.

* **í•µì‹¬ ì›ë¦¬ (What?)**

  * `@RequestBody`ëŠ” multipartë¥¼ ì²˜ë¦¬í•  ìˆ˜ ì—†ë‹¤.
  * `@RequestPart`ëŠ” ê° íŒŒíŠ¸ë¥¼ ê°œë³„ì ìœ¼ë¡œ ë°”ì¸ë”©í•œë‹¤.

* **ë¬¸ë²• ë° ì‚¬ìš©ë²• (How?)**

  ```javascript
  const formData = new FormData();
  formData.append('data', new Blob([JSON.stringify(payload)], { type: 'application/json' }));
  images.forEach(img => formData.append('files', img.file));
  ```

  ```java
  @PostMapping
  public ResponseEntity<?> createTravelLogs(
      @RequestParam Long tripId,
      @RequestPart(name = "data") @Valid TravelLogRequestDto requestDto,
      @RequestPart(name = "files") List<MultipartFile> files
  ) { ... }
  ```

* **ì£¼ì˜ì‚¬í•­ ë° ì‹¤ë¬´ íŒ (Watch out for)**
  `@RequestPart`ì˜ `name`ì€ í”„ë¡ íŠ¸ì—”ë“œì˜ `FormData.append()` í‚¤ì™€ ë°˜ë“œì‹œ ì¼ì¹˜í•´ì•¼ í•œë‹¤.

---

### 4. í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ì—…ë¡œë“œ UI ì²˜ë¦¬

* **í•™ìŠµ ëª©í‘œ (Why?)**
  íŒŒì¼ ì—…ë¡œë“œ UIì—ì„œ ì‚¬ìš©ì ê²½í—˜ì„ ë†’ì´ê³ , ì—¬ëŸ¬ íŒŒì¼ì„ ì§ê´€ì ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆë„ë¡ í•˜ê¸° ìœ„í•¨ì´ë‹¤.

* **í•µì‹¬ ì›ë¦¬ (What?)**

  * `File` ê°ì²´ì™€ `URL.createObjectURL`ì„ í™œìš©í•´ ë¯¸ë¦¬ë³´ê¸°ë¥¼ êµ¬í˜„í•œë‹¤.
  * `draggable` ì†ì„±ê³¼ `drag` ì´ë²¤íŠ¸ë¥¼ í™œìš©í•´ ìˆœì„œ ë³€ê²½ì„ ì²˜ë¦¬í•œë‹¤.
  * ì„ íƒëœ íŒŒì¼ê³¼ íƒœê·¸ ë“±ì€ ìƒíƒœ(state) ê°ì²´ì— ì¼ê´€ë˜ê²Œ ì €ì¥í•˜ê³ , ìƒíƒœ ë³€ê²½ ì‹œ UIë¥¼ ì¬ë Œë”ë§í•œë‹¤.

* **ë¬¸ë²• ë° ì‚¬ìš©ë²• (How?)**

  ```javascript
  fileInput.addEventListener('change', e => {
    const files = e.target.files;
    files.forEach(file => {
      const preview = document.createElement('img');
      preview.src = URL.createObjectURL(file);
      preview.draggable = true;
      container.appendChild(preview);
    });
  });
  ```

* **ì£¼ì˜ì‚¬í•­ ë° ì‹¤ë¬´ íŒ (Watch out for)**
  ìƒíƒœ ê´€ë¦¬ ë¡œì§ì„ ëª…í™•íˆ ë¶„ë¦¬í•˜ì§€ ì•Šìœ¼ë©´ DOM ì¡°ì‘ì´ ë³µì¡í•´ì§€ê³  ì˜¤ë¥˜ê°€ ë°œìƒí•˜ê¸° ì‰½ë‹¤. Reactë‚˜ Vue ê°™ì€ í”„ë ˆì„ì›Œí¬ì—ì„œëŠ” ìƒíƒœ ê´€ë¦¬ì™€ ë Œë”ë§ì„ ìë™í™”í•´ì£¼ë¯€ë¡œ ë” ì•ˆì •ì ìœ¼ë¡œ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.

---

## ì˜¤ëŠ˜ì˜ ê¹¨ë‹¬ìŒ ğŸ’¡

* ë‹¤ëŒ€ë‹¤ ê´€ê³„ëŠ” ë‹¨ìˆœíˆ `@ManyToMany`ë¡œ í•´ê²°í•˜ì§€ ì•Šê³  ì—°ê²° ì—”í‹°í‹°ë¥¼ í†µí•´ í’€ì–´ë‚´ëŠ” ê²ƒì´ ë” ë‚˜ì€ ì„¤ê³„ ë°©ì‹ì´ë‹¤.

* íŒŒì¼ ì—…ë¡œë“œëŠ” DBì™€ íŒŒì¼ ì‹œìŠ¤í…œì˜ ì±…ì„ì„ ë¶„ë¦¬í•´ì•¼ í•œë‹¤ëŠ” ì›ì¹™ì„ ì²´ë“í–ˆë‹¤.

* `@RequestPart`ëŠ” JSONê³¼ íŒŒì¼ì„ ë™ì‹œì— ë‹¤ë£¨ëŠ” ìƒí™©ì—ì„œ í•„ìˆ˜ì ì¸ ê¸°ëŠ¥ì„ì„ í™•ì¸í–ˆë‹¤.

* í”„ë¡ íŠ¸ì—”ë“œ UIëŠ” ìƒíƒœ ê´€ë¦¬ê°€ í•µì‹¬ì´ë¼ëŠ” ì ì„ ë‹¤ì‹œ í•œ ë²ˆ ê¹¨ë‹¬ì•˜ë‹¤.