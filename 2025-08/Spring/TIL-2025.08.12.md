# TIL - 2025.08.12 - QueryDSLì„ ì´ìš©í•œ ë™ì  ì¿¼ë¦¬ ë° í˜ì´ì§• êµ¬í˜„ ê°œë… ì´í•´

## ì¹´í…Œê³ ë¦¬ ğŸ·ï¸

#TIL #Java #Spring #SpringDataJPA #QueryDSL #DynamicQuery #Pagination #RepositoryPattern #DTO #Enum

---

## ì˜¤ëŠ˜ ë°°ìš´ ë‚´ìš© ğŸ”

* QueryDSLì„ ì´ìš©í•œ ë™ì  `WHERE` ì ˆ êµ¬í˜„ (`BooleanBuilder`, ê²€ìƒ‰ ì¡°ê±´ DTO)
* QueryDSLì„ ì´ìš©í•œ ë™ì  `ORDER BY` ì ˆ êµ¬í˜„ (`OrderSpecifier`, í—¬í¼ ë©”ì„œë“œ)
* Spring Data JPA `Pageable`ê³¼ QueryDSLì„ í†µí•©í•œ í˜ì´ì§• ì²˜ë¦¬ (`PageImpl`)
* JPA ê¸°ë³¸ ê¸°ëŠ¥ê³¼ ë³µì¡í•œ ì¡°íšŒ ë¡œì§ì„ ë¶„ë¦¬í•˜ëŠ” ì»¤ìŠ¤í…€ Repository ì„¤ê³„ íŒ¨í„´
* ì—”í‹°í‹° ë‚´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í¬í•¨ ë°©ì‹ (`getDuration`, `isOngoing`)
* `Enum` ê¸°ë°˜ ìƒíƒœ ê´€ë¦¬ (`TripStatus`)

---

## ì–´ë ¤ì› ë˜ ì  ğŸ’£

* `TripRepository`, `TripRepositoryCustom`, `TripRepositoryImpl`ë¡œ ë‚˜ë‰˜ëŠ” êµ¬ì¡°ê°€ ì²˜ìŒì—ëŠ” ê³¼í•˜ë‹¤ê³  ëŠê»´ì¡Œë‹¤. ì—­í•  ë¶„ë¦¬ë¥¼ í†µí•œ ì‘ì§‘ë„Â·ê°€ë…ì„± í–¥ìƒì´ë¼ëŠ” ëª©ì ì„ í™•ì¸í•˜ê³  ìˆ˜ìš©í–ˆë‹¤.

* ë¬¸ìì—´ íŒŒë¼ë¯¸í„°(`sortBy`)ë¥¼ QueryDSL ì •ë ¬ ê°ì²´ë¡œ ë³€í™˜í•˜ëŠ” ë°©ë²•ì´ ë§‰ë§‰í–ˆë‹¤. `OrderSpecifier`ë¥¼ ë°˜í™˜í•˜ëŠ” í—¬í¼ ë©”ì„œë“œë¡œ í•´ê²°í–ˆë‹¤.

* `Page`ê°€ ë‚´ë¶€ì ìœ¼ë¡œ ì–´ë–»ê²Œ êµ¬ì„±ë˜ëŠ”ì§€ ê¶ê¸ˆí–ˆë‹¤. ì½˜í…ì¸  ì¡°íšŒ ì¿¼ë¦¬ì™€ ë³„ë„ì˜ ì „ì²´ ì¹´ìš´íŠ¸ ì¿¼ë¦¬ë¥¼ í•©ì³ `PageImpl`ë¡œ ë§Œë“ ë‹¤ëŠ” ì ì„ ì½”ë“œë¡œ í™•ì¸í–ˆë‹¤.

* `TripSearchCondition`ì„ ì»¤ìŠ¤í…€ ì¸í„°í˜ì´ìŠ¤ ë‚´ë¶€ static í´ë˜ìŠ¤ë¡œ ë‘” ì´ìœ ê°€ ë‚¯ì„¤ì—ˆë‹¤. í•´ë‹¹ Repository ë§¥ë½ì— ê°•í•˜ê²Œ ê²°í•©ëœ ì¡°ê±´ ëª¨ë¸ì„ ì‘ì§‘ì‹œí‚¤ë ¤ëŠ” ì„ íƒì„ì„ ì´í•´í–ˆë‹¤.

---

## ì •ë¦¬ ğŸ–‡ï¸

### 1. ì»¤ìŠ¤í…€ Repository ì„¤ê³„ íŒ¨í„´

Spring Data JPA ê¸°ë³¸ ê¸°ëŠ¥ê³¼ ë³µì¡í•œ QueryDSL ë¡œì§ì„ ë¶„ë¦¬í•´ ìœ ì§€ë³´ìˆ˜ì„±ê³¼ í…ŒìŠ¤íŠ¸ ìš©ì´ì„±ì„ í™•ë³´í•œë‹¤.

* **í•™ìŠµ ëª©í‘œ (Why?)**
  CRUD/Query MethodëŠ” ê°„ê²°í•˜ê²Œ ìœ ì§€í•˜ê³ , ë™ì  ì¿¼ë¦¬Â·í˜ì´ì§•ì²˜ëŸ¼ ë³µì¡í•œ ë¡œì§ì€ ë³„ë„ êµ¬í˜„ í´ë˜ìŠ¤ë¡œ ë¶„ë¦¬í•´ ì±…ì„ì„ ëª…í™•íˆ í•œë‹¤.

* **í•µì‹¬ ì›ë¦¬ (What?)**

  1. `TripRepositoryCustom`ì— ë³µì¡ ì¿¼ë¦¬ ì‹œê·¸ë‹ˆì²˜ ì„ ì–¸
  2. `TripRepository`ê°€ `JpaRepository`ì™€ `TripRepositoryCustom`ì„ ë™ì‹œ ìƒì†
  3. `TripRepositoryImpl`ì—ì„œ ì‹¤ì œ QueryDSL ë¡œì§ êµ¬í˜„ (`...Impl` ì ‘ë¯¸ì‚¬ ê·œì¹™)

* **ë¬¸ë²• ë° ì‚¬ìš©ë²• (How?)**

  ```java
  public interface TripRepositoryCustom {
    Page<Trip> findTripsByUser(User user, TripSearchCondition condition, Pageable pageable);
  }

  public interface TripRepository extends JpaRepository<Trip, Long>, TripRepositoryCustom {
  }

  @Repository
  @RequiredArgsConstructor
  public class TripRepositoryImpl implements TripRepositoryCustom {
    private final JPAQueryFactory factory;
    @Override
    public Page<Trip> findTripsByUser(...) { /* ... */ }
  }
  ```

* **ì£¼ì˜ì‚¬í•­ ë° ì‹¤ë¬´ íŒ (Watch out for)**

  * `...Impl` ì ‘ë¯¸ì‚¬ ê·œì¹™ì„ ì§€ì¼œì•¼ Spring Dataê°€ ìë™ ì—°ê²°í•œë‹¤.
  * ë³µì¡ ì¡°íšŒê°€ ë§ì€ ì„œë¹„ìŠ¤ì—ì„œ í‘œì¤€ì ìœ¼ë¡œ ì“°ì´ëŠ” íŒ¨í„´ì´ë‹¤.

---

### 2. QueryDSL ë™ì  ì¿¼ë¦¬ (WHERE, ORDER BY)

ì¡°ê±´ ì¡´ì¬ ì—¬ë¶€ì— ë”°ë¼ `WHERE`ë¥¼ ì¡°í•©í•˜ê³ , ë¬¸ìì—´ ê¸°ì¤€ ì •ë ¬ì„ ì•ˆì „í•˜ê²Œ ë³€í™˜í•œë‹¤.

* **í•™ìŠµ ëª©í‘œ (Why?)**
  ë‹¤ì–‘í•œ í•„í„°Â·ì •ë ¬ ì˜µì…˜ì„ ìœ ì—°í•˜ê²Œ ìˆ˜ìš©í•˜ë©´ì„œ, ì„œë¹„ìŠ¤ ê³„ì¸µì˜ ë¶„ê¸°ë¥¼ ìµœì†Œí™”í•œë‹¤.

* **í•µì‹¬ ì›ë¦¬ (What?)**

  * **ë™ì  WHERE**: `BooleanBuilder`ì— ì¡°ê±´ ì¡´ì¬ ì‹œ `.and()`ë¡œ ëˆ„ì 
  * **ë™ì  ORDER BY**: `sortBy`, `direction` ê°’ì„ `OrderSpecifier`ë¡œ ë§¤í•‘

* **ë¬¸ë²• ë° ì‚¬ìš©ë²• (How?)**

  ```java
  // TripRepositoryImpl.java
  public Page<Trip> findTripsByUser(User user, TripSearchCondition condition, Pageable pageable) {
    BooleanBuilder where = new BooleanBuilder()
        .and(trip.user.eq(user));

    if (condition.getStatus() != null) {
      where.and(trip.status.eq(condition.getStatus()));
    }
    if (condition.getDestination() != null) {
      where.and(trip.destination.containsIgnoreCase(condition.getDestination()));
    }

    List<Trip> content = factory
        .selectFrom(trip)
        .where(where)
        .orderBy(getOrderSpecifier(condition))
        .offset(pageable.getOffset())
        .limit(pageable.getPageSize())
        .fetch();

    Long total = factory
        .select(trip.count())
        .from(trip)
        .where(where)
        .fetchOne();

    return new PageImpl<>(content, pageable, total == null ? 0L : total);
  }

  private OrderSpecifier<?> getOrderSpecifier(TripSearchCondition c) {
    boolean desc = "DESC".equalsIgnoreCase(c.getSortDirection());
    switch (c.getSortBy() == null ? "" : c.getSortBy().toLowerCase()) {
      case "startdate": return desc ? trip.startDate.desc() : trip.startDate.asc();
      case "enddate":   return desc ? trip.endDate.desc()   : trip.endDate.asc();
      case "status":    return desc ? trip.status.desc()    : trip.status.asc();
      default:          return trip.createdAt.desc(); // ê¸°ë³¸ ì •ë ¬
    }
  }
  ```

* **ì£¼ì˜ì‚¬í•­ ë° ì‹¤ë¬´ íŒ (Watch out for)**

  * ë¬¸ìì—´ ì •ë ¬ í•„ë“œëŠ” \*\*í—ˆìš© ëª©ë¡(allowlist)\*\*ìœ¼ë¡œë§Œ ë§¤í•‘í•´ SQL ì¸ì ì…˜ ìœ„í—˜ì„ ì°¨ë‹¨í•œë‹¤.
  * `containsIgnoreCase`ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ `lower()` ë¹„êµê°€ ìˆ˜í–‰ë˜ë¯€ë¡œ ì¸ë±ìŠ¤ ì‚¬ìš©ì„±ì— ìœ ì˜í•œë‹¤(í•„ìš” ì‹œ ì •ê·œí™” ì»¬ëŸ¼ ë˜ëŠ” ë³„ë„ ê²€ìƒ‰ ì»¬ëŸ¼ ê³ ë ¤).

---

### 3. QueryDSL í˜ì´ì§• ì²˜ë¦¬

ì½˜í…ì¸  ì¿¼ë¦¬ì™€ ì¹´ìš´íŠ¸ ì¿¼ë¦¬ë¥¼ ë¶„ë¦¬í•´ `Page`ë¥¼ êµ¬ì„±í•œë‹¤.

* **í•™ìŠµ ëª©í‘œ (Why?)**
  ëŒ€ëŸ‰ ë°ì´í„°ì—ì„œ í˜ì´ì§€ ë‹¨ìœ„ ì œê³µê³¼ ì´ ê°œìˆ˜ ì œê³µì„ ë™ì‹œì— ë§Œì¡±í•œë‹¤.

* **í•µì‹¬ ì›ë¦¬ (What?)**

  * **ì½˜í…ì¸  ì¿¼ë¦¬**: `where + orderBy + offset + limit`
  * **ì¹´ìš´íŠ¸ ì¿¼ë¦¬**: ë™ì¼ `where`ë¡œ ì´í•©ë§Œ ê³„ì‚°(ì •ë ¬Â·í˜ì´ì§• ì œì™¸)
  * **ê²°í•©**: `new PageImpl<>(content, pageable, totalCount)`

* **ë¬¸ë²• ë° ì‚¬ìš©ë²• (How?)**

  ```java
  List<Trip> content = factory
      .selectFrom(trip)
      .where(where)
      .orderBy(getOrderSpecifier(condition))
      .offset(pageable.getOffset())
      .limit(pageable.getPageSize())
      .fetch();

  Long total = factory
      .select(trip.count())
      .from(trip)
      .where(where)
      .fetchOne();

  return new PageImpl<>(content, pageable, total == null ? 0L : total);
  ```

* **ì£¼ì˜ì‚¬í•­ ë° ì‹¤ë¬´ íŒ (Watch out for)**

  * ì¹´ìš´íŠ¸ ì¿¼ë¦¬ì—ëŠ” `orderBy`ë¥¼ ë„£ì§€ ì•ŠëŠ”ë‹¤.
  * `fetchOne()`ì€ `null` ê°€ëŠ¥ì„±ì´ ìˆìœ¼ë¯€ë¡œ ì•ˆì „ ì²˜ë¦¬ê°€ í•„ìš”í•˜ë‹¤.
  * ë³µì¡ ì¡°ì¸/í•„í„°ì—ì„œëŠ” ì¹´ìš´íŠ¸ ì¿¼ë¦¬ë¥¼ ë‹¨ìˆœí™”í•´ ì„±ëŠ¥ì„ í™•ë³´í•œë‹¤.

---

### 4. ì—”í‹°í‹°ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í¬í•¨

ë‹¨ìˆœ ë°ì´í„° ë³´ê´€ì„ ë„˜ì–´, ë„ë©”ì¸ ê·œì¹™ì„ ì—”í‹°í‹°ì— ìº¡ìŠí™”í•œë‹¤.

* **í•™ìŠµ ëª©í‘œ (Why?)**
  ë„ë©”ì¸ ë¡œì§ì„ ì—”í‹°í‹°ë¡œ ì´ë™í•´ ì‘ì§‘ë„ë¥¼ ë†’ì´ê³  ì„œë¹„ìŠ¤ ë ˆì´ì–´ ë¶„ê¸°ë¥¼ ì¤„ì¸ë‹¤.

* **í•µì‹¬ ì›ë¦¬ (What?)**

  * `getDuration()`: `startDate`\~`endDate` ê¸°ê°„ ê³„ì‚°
  * `isOngoing()`: í˜„ì¬ ì‹œì ì´ ê¸°ê°„ ë‚´ì¸ì§€ íŒë‹¨
  * `TripStatus` `Enum`: ìƒíƒœ ì „ì´ì™€ í‘œí˜„ì„ ì¼ê´€ë˜ê²Œ ê´€ë¦¬

* **ë¬¸ë²• ë° ì‚¬ìš©ë²• (How?)**

  ```java
  @Entity
  public class Trip {
    // ...
    public long getDuration() {
      return ChronoUnit.DAYS.between(this.startDate, this.endDate);
    }
    public boolean isOngoing(LocalDate now) {
      return (now.isEqual(startDate) || now.isAfter(startDate))
          && (now.isBefore(endDate) || now.isEqual(endDate));
    }
  }
  ```

* **ì£¼ì˜ì‚¬í•­ ë° ì‹¤ë¬´ íŒ (Watch out for)**

  * ì—”í‹°í‹° ë©”ì„œë“œëŠ” **ë¶€ì‘ìš© ì—†ëŠ” ê³„ì‚°/íŒë‹¨**ì— ì§‘ì¤‘í•œë‹¤(íŠ¸ëœì­ì…˜ ì™¸ë¶€ ë³€ê²½ ì§€ì–‘).
  * ìƒíƒœ ì „ì´ëŠ” `Enum`ê³¼ ë©”ì„œë“œ ì¡°í•©ìœ¼ë¡œ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í•¨ê»˜ ì œê³µí•œë‹¤.

---

## ì˜¤ëŠ˜ì˜ ê¹¨ë‹¬ìŒ ğŸ’¡

* ì»¤ìŠ¤í…€ Repository íŒ¨í„´ìœ¼ë¡œ CRUDì™€ ë³µì¡ ì¡°íšŒ ë¡œì§ì„ ë¶„ë¦¬í•˜ë©´ ì‘ì§‘ë„ì™€ ê°€ë…ì„±ì´ ë†’ì•„ì§„ë‹¤.

* `BooleanBuilder`ì™€ `OrderSpecifier`ë¥¼ ì‚¬ìš©í•˜ë©´ ì¡°ê±´ ì¶”ê°€Â·ì •ë ¬ ë³€ê²½ ìš”êµ¬ì‚¬í•­ì„ ì•ˆì „í•˜ê²Œ ìˆ˜ìš©í•  ìˆ˜ ìˆë‹¤.

* í˜ì´ì§•ì€ ì½˜í…ì¸ ì™€ ì¹´ìš´íŠ¸ ì¿¼ë¦¬ë¥¼ ë¶„ë¦¬í•´ ì •í™•í•œ ì´ê°œìˆ˜ë¥¼ ì œê³µí•˜ëŠ” ê²ƒì´ í•µì‹¬ì´ë‹¤.

* ì—”í‹°í‹°ì— ê³„ì‚°/íŒë‹¨ ë¡œì§ì„ í¬í•¨í•˜ë©´ ë„ë©”ì¸ ê·œì¹™ì´ ëª…í™•í•´ì§€ê³  ì„œë¹„ìŠ¤ ë ˆì´ì–´ê°€ ë‹¨ìˆœí•´ì§„ë‹¤.