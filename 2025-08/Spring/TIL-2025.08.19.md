# TIL - 2025.08.19 - JPA ë‹¤ëŒ€ë‹¤ ê´€ê³„ ë§¤í•‘ê³¼ íŒŒì¼ ì—…ë¡œë“œ êµ¬í˜„ ê°œë… ì´í•´

## ì¹´í…Œê³ ë¦¬ ğŸ·ï¸

#TIL #Spring #JPA #ManyToMany #FileUpload #Multipart #JavaScript

---

## ì˜¤ëŠ˜ ë°°ìš´ ë‚´ìš© ğŸ”

* JPAì—ì„œ ë‹¤ëŒ€ë‹¤(M\:N) ê´€ê³„ë¥¼ ì—°ê²° ì—”í‹°í‹°(`TravelLogTag`)ë¥¼ í†µí•´ êµ¬í˜„í•˜ëŠ” ë°©ë²•
* Spring Bootì—ì„œ íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ íë¦„ (ë¡œì»¬ ì €ì¥ ë° ë©”íƒ€ë°ì´í„° DB ê´€ë¦¬)
* `multipart/form-data` ìš”ì²­ì„ `@RequestPart` ì• ë…¸í…Œì´ì…˜ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ë°©ë²•
* ì™¸ë¶€ ê²½ë¡œì˜ ì •ì  ë¦¬ì†ŒìŠ¤ë¥¼ ì›¹ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •í•˜ëŠ” ë°©ë²• (`WebMvcConfigurer`)
* JPA ì—”í‹°í‹° ë‚´ í¸ì˜ ë©”ì„œë“œì˜ ì—­í• ê³¼ í•„ìš”ì„±
* í”„ë¡ íŠ¸ì—”ë“œì—ì„œ íŒŒì¼ ì—…ë¡œë“œ ì‹œ ìƒíƒœ ê´€ë¦¬ì™€ UI ë°˜ì˜ ì „ëµ

---

## ì–´ë ¤ì› ë˜ ì  ğŸ’£

* ë‹¤ëŒ€ë‹¤ ê´€ê³„ë¥¼ í•´ì†Œí•˜ëŠ” ì—°ê²° ì—”í‹°í‹°ì˜ PKë¥¼ **ë³µí•© í‚¤**ë¡œ í• ì§€, **ëŒ€ë¦¬ í‚¤**ë¡œ í• ì§€ ì„ íƒì´ ì–´ë ¤ì› ë‹¤. ì‹¤ë¬´ì—ì„œëŠ” ëŒ€ë¦¬ í‚¤ ê¸°ë°˜ ë¹„ì‹ë³„ ê´€ê³„ê°€ ë” ì„ í˜¸ëœë‹¤ëŠ” ì ì„ í™•ì¸í–ˆë‹¤.

* JSONê³¼ íŒŒì¼ì„ ë™ì‹œì— ì²˜ë¦¬í•  ë•Œ `@RequestBody`ë¡œëŠ” ë¶ˆê°€ëŠ¥í•˜ê³  `@RequestPart`ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤ëŠ” ì ì´ ì²˜ìŒì—ëŠ” í˜¼ë€ìŠ¤ëŸ¬ì› ë‹¤.

* ë¡œì»¬ ê²½ë¡œ(`C:/uploads/...`)ì™€ ì›¹ ì ‘ê·¼ ê²½ë¡œ(`/uploads/...`)ì˜ ì°¨ì´ë¥¼ êµ¬ë¶„í•˜ëŠ” ë° ì‹œê°„ì´ ê±¸ë ¸ë‹¤. `WebMvcConfigurer`ë¥¼ í†µí•œ ë§¤í•‘ì´ í•„ìˆ˜ì ì´ì—ˆë‹¤.

* ì—¬ëŸ¬ íŒŒì¼ì„ ì„ íƒ, ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°, ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ ìˆœì„œ ë³€ê²½ê¹Œì§€ êµ¬í˜„í•˜ë ¤ë‹ˆ ìƒíƒœ ê´€ë¦¬ ë¡œì§ì´ ë³µì¡í•´ì¡Œë‹¤.

---

## ì •ë¦¬ ğŸ–‡ï¸

### 1. ì—°ê²° ì—”í‹°í‹°ë¥¼ í†µí•œ ë‹¤ëŒ€ë‹¤(M\:N) ê´€ê³„ ë§¤í•‘

* **í•™ìŠµ ëª©í‘œ (Why?)**
  `@ManyToMany`ì˜ í•œê³„ë¥¼ ê·¹ë³µí•˜ê³ , ê´€ê³„ì— ì¶”ê°€ ë°ì´í„°ë¥¼ ì €ì¥í•  ìˆ˜ ìˆëŠ” ìœ ì—°í•œ ì„¤ê³„ë¥¼ í•˜ê¸° ìœ„í•¨ì´ë‹¤.

* **í•µì‹¬ ì›ë¦¬ (What?)**

  * ì¤‘ê°„ ì—”í‹°í‹°(`TravelLogTag`)ë¥¼ ë‘ì–´ 1\:N - N:1 ê´€ê³„ë¡œ í’€ì–´ë‚¸ë‹¤.
  * ëŒ€ë¦¬ í‚¤(`id`)ë¥¼ ì‚¬ìš©í•œ ë¹„ì‹ë³„ ê´€ê³„ê°€ ê´€ë¦¬ì™€ í™•ì¥ì„± ë©´ì—ì„œ ìœ ë¦¬í•˜ë‹¤.
  * ì—°ê²° ì—”í‹°í‹°ì— `createdAt` ê°™ì€ ì¶”ê°€ ì •ë³´ë¥¼ ë‹´ì„ ìˆ˜ ìˆë‹¤.

* **ë¬¸ë²• ë° ì‚¬ìš©ë²• (How?)**

  ```java
  @Entity
  public class TravelLogTag {
      @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
      private Long id;

      @ManyToOne(fetch = FetchType.LAZY)
      @JoinColumn(name = "travel_log_id")
      private TravelLog travelLog;

      @ManyToOne(fetch = FetchType.LAZY)
      @JoinColumn(name = "tag_id")
      private Tag tag;
  }
  ```

* **ì£¼ì˜ì‚¬í•­ ë° ì‹¤ë¬´ íŒ (Watch out for)**
  `addTag(Tag tag)` ê°™ì€ í¸ì˜ ë©”ì„œë“œë¥¼ ë‘ë©´ ì„œë¹„ìŠ¤ ê³„ì¸µ ì½”ë“œê°€ ê°„ê²°í•´ì§€ê³  ì‘ì§‘ë„ê°€ ì˜¬ë¼ê°„ë‹¤.

---

### 2. Spring Boot íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬

* **í•™ìŠµ ëª©í‘œ (Why?)**
  íŒŒì¼ ì €ì¥ê³¼ ë©”íƒ€ë°ì´í„° ê´€ë¦¬ë¥¼ ë¶„ë¦¬í•´ íš¨ìœ¨ì ì´ê³  í™•ì¥ì„± ìˆëŠ” ì„¤ê³„ë¥¼ í•˜ê¸° ìœ„í•¨ì´ë‹¤.

* **í•µì‹¬ ì›ë¦¬ (What?)**

  * ì‹¤ì œ íŒŒì¼ì€ íŒŒì¼ ì‹œìŠ¤í…œ(ë˜ëŠ” í´ë¼ìš°ë“œ ìŠ¤í† ë¦¬ì§€)ì— ì €ì¥í•œë‹¤.
  * DBì—ëŠ” íŒŒì¼ ê²½ë¡œë‚˜ URL, ì›ë³¸ ì´ë¦„ ë“±ì˜ ë©”íƒ€ë°ì´í„°ë§Œ ì €ì¥í•œë‹¤.

* **ë¬¸ë²• ë° ì‚¬ìš©ë²• (How?)**

  ```java
  String storedFileName = UUID.randomUUID() + ".jpg";
  Path target = userBasePath.resolve(storedFileName);
  Files.copy(file.getInputStream(), target);

  TravelPhoto photo = TravelPhoto.builder()
      .filePath("/uploads/" + username + "/" + storedFileName)
      .build();
  travelPhotoRepository.save(photo);
  ```

* **ì£¼ì˜ì‚¬í•­ ë° ì‹¤ë¬´ íŒ (Watch out for)**
  ìš´ì˜ í™˜ê²½ì—ì„œëŠ” AWS S3ì™€ ê°™ì€ í´ë¼ìš°ë“œ ìŠ¤í† ë¦¬ì§€ë¥¼ í™œìš©í•˜ëŠ” ê²ƒì´ ì¼ë°˜ì ì´ë‹¤.
  ì—…ë¡œë“œ ì‹œ íŒŒì¼ í¬ê¸°ì™€ MIME Typeì„ ë°˜ë“œì‹œ ê²€ì¦í•´ì•¼ í•œë‹¤.

---

### 3. @RequestPartë¥¼ ì´ìš©í•œ Multipart ìš”ì²­ ì²˜ë¦¬

* **í•™ìŠµ ëª©í‘œ (Why?)**
  JSON ë°ì´í„°ì™€ íŒŒì¼ì„ í•˜ë‚˜ì˜ API ìš”ì²­ìœ¼ë¡œ ì²˜ë¦¬í•´ íš¨ìœ¨ì„±ì„ ë†’ì´ê¸° ìœ„í•¨ì´ë‹¤.

* **í•µì‹¬ ì›ë¦¬ (What?)**

  * `@RequestBody`ëŠ” `multipart/form-data`ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ì—†ë‹¤.
  * `@RequestPart`ëŠ” ìš”ì²­ì˜ ê° íŒŒíŠ¸ë¥¼ ê°œë³„ íŒŒë¼ë¯¸í„°ë¡œ ë°”ì¸ë”©í•œë‹¤.

* **ë¬¸ë²• ë° ì‚¬ìš©ë²• (How?)**

  ```javascript
  const formData = new FormData();
  formData.append('data', new Blob([JSON.stringify(payload)], { type: 'application/json' }));
  images.forEach(img => formData.append('files', img.file));
  ```

  ```java
  @PostMapping
  public ResponseEntity<?> createTravelLogs(
      @RequestParam Long tripId,
      @RequestPart(name = "data") @Valid TravelLogRequestDto requestDto,
      @RequestPart(name = "files") List<MultipartFile> files
  ) { ... }
  ```

* **ì£¼ì˜ì‚¬í•­ ë° ì‹¤ë¬´ íŒ (Watch out for)**
  `@RequestPart`ì˜ name ì†ì„±ì€ í”„ë¡ íŠ¸ì—”ë“œì˜ `FormData.append()` í‚¤ì™€ ë°˜ë“œì‹œ ì¼ì¹˜í•´ì•¼ í•œë‹¤.

---

### 4. í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ì—…ë¡œë“œ ìƒíƒœ ê´€ë¦¬

* **í•™ìŠµ ëª©í‘œ (Why?)**
  ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ íŒŒì¼ì„ ì§ê´€ì ìœ¼ë¡œ í™•ì¸í•˜ê³ , ìˆœì„œë¥¼ ë°”ê¾¸ëŠ” ë“± ìƒí˜¸ì‘ìš©ì„±ì„ ë†’ì´ê¸° ìœ„í•¨ì´ë‹¤.

* **í•µì‹¬ ì›ë¦¬ (What?)**

  * `File` ê°ì²´ì™€ `URL.createObjectURL`ë¡œ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ë§Œë“ ë‹¤.
  * `drag` ì´ë²¤íŠ¸ë¡œ íŒŒì¼ ìˆœì„œë¥¼ ì œì–´í•œë‹¤.
  * íŒŒì¼, íƒœê·¸ ë“±ì€ ìƒíƒœ(state) ê°ì²´ì— ì €ì¥í•˜ê³  ìƒíƒœ ë³€ê²½ ì‹œ UIë¥¼ ì¬ë Œë”ë§í•œë‹¤.

* **ë¬¸ë²• ë° ì‚¬ìš©ë²• (How?)**

  ```javascript
  fileInput.addEventListener('change', e => {
    [...e.target.files].forEach(file => {
      const preview = document.createElement('img');
      preview.src = URL.createObjectURL(file);
      preview.draggable = true;
      container.appendChild(preview);
    });
  });
  ```

* **ì£¼ì˜ì‚¬í•­ ë° ì‹¤ë¬´ íŒ (Watch out for)**
  ìƒíƒœ ê´€ë¦¬ê°€ ëª…í™•íˆ ë¶„ë¦¬ë˜ì§€ ì•Šìœ¼ë©´ DOM ì¡°ì‘ì´ ë³µì¡í•´ì§€ê³  ì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤.
  React/Vue ê°™ì€ í”„ë ˆì„ì›Œí¬ëŠ” ìƒíƒœì™€ UI ë Œë”ë§ì„ ìë™ìœ¼ë¡œ ë™ê¸°í™”í•´ì£¼ë¯€ë¡œ ë” ì•ˆì •ì ì´ë‹¤.

---

## ì˜¤ëŠ˜ì˜ ê¹¨ë‹¬ìŒ ğŸ’¡

* ë‹¤ëŒ€ë‹¤ ê´€ê³„ëŠ” `@ManyToMany`ë³´ë‹¤ ì—°ê²° ì—”í‹°í‹°ë¡œ í’€ì–´ë‚´ëŠ” ê²ƒì´ ë” ì¢‹ì€ ì„¤ê³„ë‹¤.

* íŒŒì¼ ì—…ë¡œë“œëŠ” DBì™€ íŒŒì¼ ì‹œìŠ¤í…œì˜ ì±…ì„ì„ ë‚˜ëˆ„ëŠ” ê²ƒì´ í•µì‹¬ì´ë‹¤.

* `@RequestPart`ëŠ” JSONê³¼ íŒŒì¼ì„ ë™ì‹œì— ì²˜ë¦¬í•˜ëŠ” ë° í•„ìˆ˜ì ì´ë‹¤.

* í”„ë¡ íŠ¸ì—”ë“œ UIëŠ” ê²°êµ­ ìƒíƒœ ê´€ë¦¬ê°€ ì•ˆì •ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ì„±ì„ ì¢Œìš°í•œë‹¤.